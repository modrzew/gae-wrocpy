<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Z głową w chmurze - Google App Engine i Google Cloud</title>

        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/theme/black.css" id="theme">
        <link rel="stylesheet" href="lib/css/zenburn.css">

        <!-- Printing and PDF exports -->
        <script>
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>

        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
                <section>
                    <h1>Hello world</h1>
                </section>
                <section>
                    <section>
                        <h2>WSGI</h2>
                    </section>
                    <section>
                        <h3>main.py</h3>
                        <pre><code class="python" data-trim>
def application(environment, start_response):
    response_body = 'We are in App Engine, whoo!'
    status = '200 OK'
    response_headers = [
        ('Content-Type', 'text/plain'),
        ('Content-Length', str(len(response_body))),
    ]
    start_response(status, response_headers)
    return [response_body]
                        </code></pre>
                        <aside class="notes"></aside>
                    </section>
                    <section>
                        <h3>app.yaml</h3>
                        <pre><code class="yaml"data-trim>
application: wrocpy
module: wsgi
version: 1
runtime: python27
api_version: 1
threadsafe: yes

handlers:
- url: /.*
  script: main.application
                        </code></pre>
                    </section>
                    <section>
                        <h3>Deployment</h3>
                        <pre><code class="bash" data-trim>
$> appcfg.py update app.yaml
11:53 AM Application: wrocpy; module: wsgi; version: 1
11:53 AM Host: appengine.google.com
11:53 AM Starting update of app: wrocpy, module: wsgi, version: 1
11:53 AM Getting current resource limits.
11:53 AM Scanning files on local disk.
11:53 AM Cloning 2 application files.
11:53 AM Uploading 1 files and blobs.
11:53 AM Uploaded 1 files and blobs.
11:53 AM Compilation starting.
11:53 AM Compilation completed.
11:53 AM Starting deployment.
11:53 AM Checking if deployment succeeded.
11:53 AM Deployment successful.
11:53 AM Checking if updated app version is serving.
11:53 AM Completed update of app: wrocpy, module: wsgi, version: 1
                        </code></pre>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Django</h2>
                    </section>

                    <section>
                        <ul>
                            <li><code>import django</code> (&lt;=1.5)</li>
                            <li>
                                nie trzeba nic zmieniać w aplikacji, żeby zaczęła działać
                                <ul>
                                    <li>poza bazą danych - ale o tym później</li>
                                </ul>
                            </li>
                        </ul>
                    </section>

                    <section>
                        <h3>Struktura projektu</h3>
                        <ul>
                            <li>
                                <code>wrocpy/</code>
                                <ul>
                                    <li>
                                        <code>hello/</code>
                                        <ul>
                                            <li><code>__init__.py</code></li>
                                            <li><code>views.py</code></li>
                                        </ul>
                                    </li>
                                    <li><code>__init__.py</code></li>
                                    <li><code>settings.py</code></li>
                                    <li><code>urls.py</code></li>
                                    <li><code>wsgi.py</code></li>
                                </ul>
                            </li>
                            <li><code>manage.py</code></li>
                            <li class="fragment"><code><b>app.yaml</b></code></li>
                        </ul>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Flask</h2>
                    </section>
                    <section>
                        <h3>:(</h3>
                        <ul>
                            <li>Flask nie jest builtinem</li>
                            <li>App Engine nie ma pojęcia co to easy_install/pip</li>
                            <li>przesyłanie eggów niewiele pomoże</li>
                            <li>co robić, jak żyć?</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Rozwiązanie</h3>
                        <ol>
                            <li>Zainstaluj paczki lokalnie</li>
                            <li>Skopiuj kod do projektu</li>
                            <li>Wgraj kod aplikacji i kod zależności razem</li>
                            <li>???</li>
                            <li>PROFIT! ...eee</li>
                        </ol>
                    </section>
                    <section>
                        <h3>Lepsze rozwiązanie:</h3>
                        <h2>buildout + appfy.recipe.gae</h2>
                        <p><a href="https://github.com/prmtl/appfy.recipe.gae">github.com/prmtl/appfy.recipe.gae</a></p>
                    </section>
                    <section>
                        <h3>setup.py</h3>
                        <pre><code class="python" data-trim>
from setuptools import (
    find_packages,
    setup,
)

install_requires = [
    'Flask'
]

setup(
    name='wrocpy-flask',
    version='1.0',
    description='',
    author='',
    packages=find_packages(''),
    install_requires=install_requires,
    tests_require=None,
    dependency_links=[],
    entry_points=None,
)
                        </code></pre>
                    </section>
                    <section>
                        <h3>buildout.cfg</h3>
                        <pre><code class="buildout" data-trim>
[buildout]
parts =
    app_lib
develop = .
eggs = wrocpy-flask

[app_lib]
recipe = appfy.recipe.gae:app_lib
lib-directory = src/libs
eggs = ${buildout:eggs}
                        </code></pre>
                    </section>
                    <section>
                        <h3>appengine_config.py</h3>
                        <pre><code class="python" data-trim>
import os
import sys

# Inject 3rd party libraries into sys.path
src_path = os.path.dirname(__file__)
distlib_path = os.path.join(src_path, 'libs')
if src_path not in sys.path:
    sys.path.insert(0, src_path)
if distlib_path not in sys.path:
    sys.path.insert(0, distlib_path)
                        </code></pre>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>webapp2</h2>
                        <p><a href="https://webapp-improved.appspot.com/">webapp-improved.appspot.com</a></p>
                    </section>
                    <section>
                        <pre><code class="python" data-trim>
import webapp2

class HelloWorldHandler(webapp2.RequestHandler):
    def get(self):
        self.response.write('Hi! I\'m running inside webapp2!')

application = webapp2.WSGIApplication([
    webapp2.Route(
        '/',
        HelloWorldHandler,
    ),
])
                        </code></pre>
                    </section>
                </section>



                <section>
                    <h1>Przechowywanie danych</h1>
                </section>

                <section>
                    <section>
                        <h2>Datastore</h2>
                    </section>
                    <section>
                        <h3>Właściwości</h3>
                        <ul>
                            <li>nierelacyjna baza danych</li>
                            <li>klucz/wartość</li>
                            <li>ewentualnie spójna (eventual consistency)</li>
                            <li>wysoka dostępność danych (zapis/odczyt)</li>
                            <li>transakcje i ACID</li>
                            <li>wsparcie dla zapytań (GQL)</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Model</h3>
                        <pre><code class="python" data-trim="">
class Hello(ndb.Model):
    count = ndb.IntegerProperty(indexed=False, default=0)
    name = ndb.StringProperty(required=True)
    description = ndb.TextProperty()
    created_at = ndb.DateTimeProperty(auto_now_add=True)
    updated_at = ndb.DateTimeProperty(auto_now=True)
    children = ndb.KeyProperty(repeated=True)
                        </code></pre>
                        <pre><code class="python" data-trim="">
hello = Hello(
    name='Hi!',
    count=3,
    children=[
        hello_key1,
        hello_key2,
    ],
)
hello.put()
                        </code></pre>
                    </section>
                    <section>
                        <h3>Hooki</h3>
                        <pre><code class="python" data-trim="">
import logging
from google.appengine.ext import ndb

class Hello(ndb.Model):
    count = ndb.IntegerProperty()

    def _pre_put_hook(self):
        logging.info('Before putting!')
        self.count += 1

    def _post_put_hook(self):
        logging.info('After putting!')
        self.count += 2
                        </code></pre>
                        <pre><code class="python" data-trim="">
>>> hello = Hello(count=5)
>>> hello.put()
INFO:root:Before putting!
INFO:root:After putting!
>>> hello.count
8
                        </code></pre>
                    </section>
                    <section>
                        <h3>Structured properties</h3>
                        <pre><code class="python" data-trim="">
class Container(ndb.Model):
    hello = ndb.StructuredProperty(Hello)
    hello_children = ndb.LocalStructuredProperty(
        Hello,
        repeated=True,
        compressed=True,
    )
    additional_data = ndb.JsonProperty(indexed=True)
    user = ndb.PickleProperty(compressed=True)
                        </code></pre>
                    </section>
                    <section>
                        <h3>Zapytania</h3>
                        <pre><code class="python" data-trim>
from datetime import datetime

query = Hello.query(Hello.created_at > datetime(2015, 4, 7))
all_results = query.fetch()
first_page, cursor, more = query.fetch_page(100)
if more:
    next_page, cursor, more = query.fetch_page(100, start_cursor=cursor)
                        </code></pre>
                    </section>
                    <section>
                        <h3>Klucz/wartość, powiadasz?</h3>
                        <pre><code class="python" data-trim>
key = ndb.Key(Hello, 581247529)
# or
key = ndb.Key('Hello', 'I can be a string too')
# or using already created object
key = hello_obj.key
# Get it!
new_obj = key.get()
print new_obj
# Hello(name='Hi!', count=3)
                        </code></pre>
                    </section>
                    <section>
                        <h3>Fajne i niefajne strony zapytań</h3>
                        <ul>
                            <li>operator <code>IN</code></li>
                            <li>tylko jeden operator nierówności na zapytanie</li>
                            <li>nie ma <code>LIKE</code>, nie ma wyszukiwania pełnotekstowego</li>
                            <li>są operatory <code>AND</code> i <code>OR</code> \o/</li>
                            <li>ale nie można ich nadużywać /o\</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Ancestor queries</h3>
                        <ul>
                            <li>obiekty w bazie mogą mieć swojego "przodka"</li>
                            <li>przodek i potomkowie należą do jednej grupy, która jest silnie spójna</li>
                            <li>limit operacji zapisu w całej grupie: 5/s</li>
                            <li>bardziej wydajne niż zwykłe zapytania</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Transakcje</h3>
                        <pre><code class="python" data-trim>
@ndb.transactional(retries=3)
def change_name(hello_key, name):
    """Changes hello's name for sure, or dies trying

    Will also return hello's last modified date.
    """
    hello = hello_key.get()
    hello.name = name
    hello.put()
    return hello.updated_at
                        </code></pre>
                    </section>
                    <section>
                        <h3>Asynchroniczność</h3>
                        <pre><code class="python" data-trim>
hello = Hello(name='Howdy!')
hello_future = hello.put_async()
another_hello_future = Hello.get_by_id_async(724)
# ...123 lines later...
hello_key = hello_future.get_result()
another_hello = another_hello_future.get_result()
                        </code></pre>
                    </section>
                    <section>
                        <h3>Asynchroniczność: tasklety</h3>
                        <pre><code class="python" data-trim>
@ndb.transactional(retries=3)
@ndb.tasklet
def change_name_async(hello_key, name):
    """Changes hello's name for sure, or dies trying

    Will also return hello's last modified date.
    """
    hello = yield hello_key.get_async()
    hello.name = name
    yield hello.put_async()
    raise ndb.Return(hello.updated_at)
                        </code></pre>
                        <pre><code class="python" data-trim>
updated_at = change_name_async(ndb.Key(Hello, 123), 'Whooo').get_result()
                        </code></pre>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>Search API</h2>
                    </section>
                    <section>
                        <ul>
                            <li>wyszukiwarka pełnotekstowa</li>
                            <li>idealna do... wyszukiwania! (w porównaniu z ndb)</li>
                        </ul>
                    </section>
                    <section>
                        <ul>
                            <li>
                                brak ograniczeń co do złożoności zapytań
                                <ul>
                                    <li><code>kopytko OR (count>7 AND (NOT type=cat OR type=lion))</code></li>
                                </ul>
                            </li>
                            <li>
                                współrzędne geograficzne:
                                <ul>
                                    <li><code>distance(loc, geopoint(12, 34)) > 10000</code></li>
                                </ul>
                            </li>
                            <li>dynamiczne sortowanie wg wyrażenia</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Wszystko fajnie, ale...</h3>
                        <ul>
                            <li>słaba dokumentacja</li>
                            <li>niespójny interfejs (np. kursor)</li>
                            <li>potrafi rzucić losowym wyjątkiem</li>
                            <li>strasznie zwalnia dla dużych zbiorów</li>
                        </ul>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>Blobstore / Cloud Storage</h2>
                    </section>
                    <section>
                        <h3>Gdzie leży problem?</h3>
                        <pre><code class="python" data-trim>
with open('sample.txt', 'w') as f:
    f.write('Something!')
                        </code></pre>
                        <pre><code data-trim>
Traceback (most recent call last):
  File "/base/data/home/runtimes/python27/python27_lib/versions/1/google/appengine/runtime/wsgi.py", line 267, in Handle
    result = handler(dict(self._environ), self._StartResponse)
  File "/base/data/home/apps/s~wrocpy/wsgi:1.383232241008519653/main.py", line 7, in application
    fopen()
  File "/base/data/home/apps/s~wrocpy/wsgi:1.383232241008519653/main.py", line 2, in fopen
    with open('file.txt', 'w') as f:
IOError: [Errno 30] Read-only file system: 'file.txt'
                        </code></pre>
                    </section>
                    <section>
                        <h3>Blobstore</h3>
                        <ul>
                            <li>klucz/wartość</li>
                            <li>odczyt/zapis danych binarnych z poziomu aplikacji</li>
                            <li>możliwość zapisywania plików od użytkownika</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Cloud Storage</h3>
                        <ul>
                            <li>zewnętrzna usługa</li>
                            <li>wiadra, katalogi i pliki</li>
                            <li>dostęp: HTTP lub <code>gsutil</code></li>
                            <li>niedostępny jako builtin ಠ_ಠ</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Images API</h3>
                        <pre><code class="python" data-trim>
from google.appengine.api import images

blob_key = some_magic_stuff()
url = images.get_serving_url(blob_key)
                        </code></pre>
                    </section>
                    <section>
                        <h4>URL</h4>
                        <pre><code data-trim>
https://lh4.ggpht.com/[a-zA-Z0-9\-]+

https://lh4.ggpht.com/0FEEDADEADF15h
                        </code></pre>
                        <h4>URL - resize</h4>
                        <pre><code data-trim>
https://lh4.ggpht.com/[a-zA-Z0-9\-]+=(w|s|h)\d+

https://lh4.ggpht.com/0FEEDADEADF15h=s300
                        </code></pre>
                        <h4>URL - resize + crop</h4>
                        <pre><code data-trim>
https://lh4.ggpht.com/[a-zA-Z0-9\-]+=(w|s|h)\d+(-c|)

https://lh4.ggpht.com/0FEEDADEADF15h=s300-c
                        </code></pre>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>BigQuery</h2>
                    </section>
                    <section>
                        <ul>
                            <li>relacyjna baza danych (hurtownia)</li>
                            <li>tylko dodawanie nowych rekordów</li>
                            <li>brak możliwości modyfikacji relacji</li>
                            <li>radzi sobie z terabajtami danych</li>
                        </ul>
                    </section>
                    <section>
                        <ul>
                            <li>zapytania są <b>wolne</b> (kilka sekund do kilku godzin)</li>
                            <li>tryb synchroniczny i asynchroniczny</li>
                            <li>tabele tymczasowe</li>
                        </ul>
                    </section>
                </section>
                <section>
                    <h2>Cloud SQL</h2>
                    <ul>
                        <li>MySQL podpięty pod aplikację w App Engine</li>
                        <li>dostępny także poza App Engine</li>
                        <li>builtin: <code>MySQLdb</code></li>
                    </ul>
                </section>
            </div>
        </div>

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.js"></script>
        <script>
            // Full list of configuration options available at:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: true,
                progress: true,
                history: true,
                center: true,

                transition: 'none', // none/fade/slide/convex/concave/zoom

                // Optional reveal.js plugins
                dependencies: [
                    {
                        src: 'lib/js/classList.js',
                        condition: function() {
                            return !document.body.classList;
                        }
                    },
                    {
                        src: 'plugin/highlight/highlight.js',
                        async: true,
                        condition: function() {
                            return !!document.querySelector( 'pre code' );
                        },
                        callback: function() {
                            hljs.initHighlightingOnLoad();
                        }
                    },
                    {
                        src: 'plugin/notes/notes.js',
                        async: true
                    }
                ]
            });
        </script>
    </body>
</html>
